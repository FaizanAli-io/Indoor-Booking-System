@page
@model IndoorBookingSystem.Pages.Bookings.CreateModel
@{
    ViewData["Title"] = "Book Indoor";
}

<style>
    .booking-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .indoor-card {
        background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        color: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .date-selector {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .time-slot {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        overflow: hidden;
    }
    
    .time-slot:hover:not(.booked) {
        border-color: #10b981;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);
    }
    
    .time-slot.selected {
        border-color: #10b981;
        background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        color: white;
        transform: scale(1.02);
    }
    
    .time-slot.booked {
        background: #f5f5f5;
        border-color: #ddd;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .time-slot .checkmark {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        color: #10b981;
        font-weight: bold;
    }
    
    .time-slot.selected .checkmark {
        display: flex;
    }
    
    .booking-summary {
        position: sticky;
        top: 20px;
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .day-badge {
        display: inline-block;
        padding: 8px 16px;
        background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        color: white;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .price-tag {
        font-size: 1.1rem;
        font-weight: 700;
        color: #28a745;
    }
    
    .total-price {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>

<div class="booking-container py-4">
    <form method="post" id="bookingForm">
        <input type="hidden" asp-for="IndoorId" />
        <input type="hidden" asp-for="SelectedDate" id="hiddenDate" />
        
        <!-- Indoor Header -->
        <div class="indoor-card mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">@Model.Indoor?.Name</h1>
                    <p class="mb-2 opacity-75">
                        <i class="bi bi-geo-alt-fill"></i> @Model.Indoor?.Location
                    </p>
                    <p class="mb-0 opacity-75">@Model.Indoor?.Description</p>
                </div>
                <div class="col-md-4 text-md-end">
                    @if (Model.Indoor?.MediaUrls?.Length > 0)
                    {
                        <img src="@Model.Indoor.MediaUrls[0]" alt="@Model.Indoor.Name" 
                             style="width: 150px; height: 150px; object-fit: cover; border-radius: 15px; border: 3px solid white;" />
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Date Selector -->
                <div class="date-selector mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-calendar-event text-primary"></i> Select Date
                    </h4>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <input type="date" class="form-control form-control-lg" 
                                   id="dateInput"
                                   value="@Model.SelectedDate.ToString("yyyy-MM-dd")"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-6">
                            <span class="day-badge">
                                <i class="bi bi-calendar3"></i> @Model.SelectedDate.ToString("dddd, MMMM dd, yyyy")
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Time Filter -->
                <div class="date-selector mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-funnel text-primary"></i> Filter by Time
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">Time Period</label>
                            <select class="form-select" id="timePeriodFilter">
                                <option value="all">All Times (24 hours)</option>
                                <option value="morning">Morning (6 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 6 PM)</option>
                                <option value="evening">Evening (6 PM - 12 AM)</option>
                                <option value="night">Night (12 AM - 6 AM)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Start Time</label>
                            <select class="form-select" id="startTimeFilter">
                                <option value="">Any</option>
                                @for (int h = 0; h < 24; h++)
                                {
                                    var displayHour = h % 12;
                                    if (displayHour == 0) displayHour = 12;
                                    var period = h >= 12 ? "PM" : "AM";
                                    <option value="@h">@displayHour:00 @period</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">End Time</label>
                            <select class="form-select" id="endTimeFilter">
                                <option value="">Any</option>
                                @for (int h = 1; h <= 24; h++)
                                {
                                    var displayHour = h % 12;
                                    if (displayHour == 0) displayHour = 12;
                                    var period = h >= 12 ? "PM" : "AM";
                                    <option value="@h">@displayHour:00 @period</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Time Slots -->
                <div class="date-selector">
                    <h4 class="mb-3">
                        <i class="bi bi-clock text-primary"></i> Select Time Slots
                    </h4>
                    <p class="text-muted mb-4">Click on available slots to select. You can select multiple slots.</p>
                    
                    <div class="row g-3" id="timeSlotsGrid">
                        @foreach (var timeSlot in Model.AllTimeSlots)
                        {
                            var isAvailable = Model.SlotAvailability[timeSlot.Id];
                            var price = Model.SlotPrices[timeSlot.Id];
                            
                            <div class="col-md-6 col-lg-4 col-xl-3">
                                <div class="time-slot @(isAvailable ? "" : "booked")" 
                                     data-slotid="@timeSlot.Id" 
                                     data-price="@price"
                                     onclick="@(isAvailable ? "toggleSlot(this)" : "")">
                                    <div class="checkmark">✓</div>
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <i class="bi bi-clock"></i>
                                            <strong>@timeSlot.DisplayName</strong>
                                        </div>
                                        @if (isAvailable)
                                        {
                                            <span class="price-tag">PKR @price.ToString("N0")</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Booked</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Booking Summary -->
                <div class="booking-summary">
                    <h4 class="mb-4">
                        <i class="bi bi-receipt text-primary"></i> Booking Summary
                    </h4>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Selected Date</small>
                        <strong id="summaryDate">@Model.SelectedDate.ToString("MMM dd, yyyy")</strong>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Selected Slots</small>
                        <div id="selectedSlotsList">
                            <span class="text-muted">No slots selected</span>
                        </div>
                    </div>

                    <hr />

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Number of Slots:</span>
                            <strong id="slotCount">0</strong>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total Price:</span>
                            <span class="total-price" id="totalPrice">PKR 0</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-lg text-white" id="confirmBtn"
                                style="background: linear-gradient(135deg, #10b981 0%, #047857 100%); border: none;"
                                disabled>
                            <i class="bi bi-check-circle"></i> Confirm Booking
                        </button>
                        <a asp-page="/Indoors/Details" asp-route-id="@Model.Indoor?.Id" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Your booking will be pending until confirmed by the admin.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let selectedSlotIds = [];

        function toggleSlot(element) {
            const slotId = parseInt(element.getAttribute('data-slotid'));
            const price = parseFloat(element.getAttribute('data-price'));

            if (element.classList.contains('selected')) {
                // Deselect
                element.classList.remove('selected');
                selectedSlotIds = selectedSlotIds.filter(s => s.slotId !== slotId);
            } else {
                // Select
                element.classList.add('selected');
                selectedSlotIds.push({ slotId, price });
            }

            updateSummary();
        }

        function updateSummary() {
            const slotCount = selectedSlotIds.length;
            const totalPrice = selectedSlotIds.reduce((sum, s) => sum + s.price, 0);

            document.getElementById('slotCount').textContent = slotCount;
            document.getElementById('totalPrice').textContent = 'PKR ' + totalPrice.toLocaleString('en-PK');

            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = slotCount === 0;

            // Update selected slots list
            const slotsList = document.getElementById('selectedSlotsList');
            if (slotCount === 0) {
                slotsList.innerHTML = '<span class="text-muted">No slots selected</span>';
            } else {
                slotsList.innerHTML = selectedSlotIds.map(s => {
                    const displayName = getSlotDisplayName(s.slotId);
                    return `<div class="mb-1"><small><i class="bi bi-check-circle-fill text-success"></i> ${displayName}</small></div>`;
                }).join('');
            }

            // Update hidden inputs
            updateHiddenInputs();
        }

        function getSlotDisplayName(slotId) {
            const hour = slotId;
            const nextHour = (slotId + 1) % 24;
            
            const startDisplay = hour % 12 || 12;
            const startPeriod = hour >= 12 ? 'PM' : 'AM';
            
            const endDisplay = nextHour % 12 || 12;
            const endPeriod = nextHour >= 12 ? 'PM' : 'AM';
            
            return `${startDisplay}:00 ${startPeriod} - ${endDisplay}:00 ${endPeriod}`;
        }

        function updateHiddenInputs() {
            // Remove existing hidden inputs
            document.querySelectorAll('input[name="SelectedSlotIds"]').forEach(el => el.remove());

            // Add new hidden inputs
            const form = document.getElementById('bookingForm');
            selectedSlotIds.forEach(s => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'SelectedSlotIds';
                input.value = s.slotId;
                form.appendChild(input);
            });
        }

        // Handle date change
        document.getElementById('dateInput').addEventListener('change', function() {
            const selectedDate = this.value;
            const indoorId = '@Model.IndoorId';
            window.location.href = `?indoorId=${indoorId}&date=${selectedDate}`;
        });

        // Time filtering functionality
        function filterSlots() {
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const startTime = document.getElementById('startTimeFilter').value;
            const endTime = document.getElementById('endTimeFilter').value;
            
            const allSlots = document.querySelectorAll('.time-slot');

            allSlots.forEach(slotElement => {
                const slotParent = slotElement.closest('.col-md-6, .col-lg-4, .col-xl-3');
                if (!slotParent) return;

                const slotId = parseInt(slotElement.getAttribute('data-slotid'));
                if (isNaN(slotId)) return;

                let show = true;

                // Filter by time period
                if (timePeriod !== 'all') {
                    switch(timePeriod) {
                        case 'morning':
                            show = slotId >= 6 && slotId < 12;
                            break;
                        case 'afternoon':
                            show = slotId >= 12 && slotId < 18;
                            break;
                        case 'evening':
                            show = slotId >= 18 && slotId < 24;
                            break;
                        case 'night':
                            show = slotId >= 0 && slotId < 6;
                            break;
                    }
                }

                // Filter by start time
                if (startTime !== '' && show) {
                    show = slotId >= parseInt(startTime);
                }

                // Filter by end time
                if (endTime !== '' && show) {
                    show = slotId < parseInt(endTime);
                }

                slotParent.style.display = show ? '' : 'none';
            });

            // Update visible count
            const visibleSlots = Array.from(allSlots).filter(s => {
                const parent = s.closest('.col-md-6, .col-lg-4, .col-xl-3');
                return parent && parent.style.display !== 'none';
            }).length;

            // Show message if no slots visible
            let noSlotsMsg = document.getElementById('noSlotsMessage');
            if (visibleSlots === 0) {
                if (!noSlotsMsg) {
                    noSlotsMsg = document.createElement('div');
                    noSlotsMsg.id = 'noSlotsMessage';
                    noSlotsMsg.className = 'alert alert-info col-12';
                    noSlotsMsg.innerHTML = '<i class="bi bi-info-circle"></i> No slots match your filter. Try adjusting the time range.';
                    document.getElementById('timeSlotsGrid').appendChild(noSlotsMsg);
                }
            } else if (noSlotsMsg) {
                noSlotsMsg.remove();
            }
        }

        // Add event listeners for filters
        document.getElementById('timePeriodFilter').addEventListener('change', filterSlots);
        document.getElementById('startTimeFilter').addEventListener('change', filterSlots);
        document.getElementById('endTimeFilter').addEventListener('change', filterSlots);
    </script>
}
