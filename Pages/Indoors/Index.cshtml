@page
@model IndoorBookingSystem.Pages.Indoors.IndexModel
@{
    ViewData["Title"] = Model.IsAdmin ? "My Facilities" : "Browse Facilities";
}

<!-- Hero Header -->
@if (Model.IsAdmin)
{
    <div class="hero-sports" style="min-height: 300px; padding: 60px 32px;">
        <div class="hero-sports-content">
            <h1 class="hero-sports-title" style="font-size: 42px;">
                <i class="bi bi-building"></i> My Facilities
            </h1>
            <p class="hero-sports-subtitle" style="font-size: 18px;">
                Manage your indoor sports facilities
            </p>
            <a asp-page="Create" class="hero-sports-cta" style="margin-top: 20px;">
                <i class="bi bi-plus-circle-fill"></i> Add New Facility
            </a>
        </div>
    </div>
}
else
{
    <div class="hero-sports" style="min-height: 300px; padding: 60px 32px;">
        <div class="hero-sports-content">
            <h1 class="hero-sports-title" style="font-size: 42px;">
                <i class="bi bi-search"></i> Find Your Arena
            </h1>
            <p class="hero-sports-subtitle" style="font-size: 18px;">
                Browse and book premium indoor sports facilities
            </p>
        </div>
    </div>
}

<div class="container" style="margin-top: -40px; position: relative; z-index: 10;">
    
    <!-- Search Filters (Customer Only) -->
    @if (!Model.IsAdmin)
    {
        <div class="card-sports mb-4 animate-fade-in">
            <div class="card-sports-body" style="padding: 32px;">
                <h5 style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: var(--color-gray-900);">
                    <i class="bi bi-funnel-fill" style="color: var(--color-primary);"></i> Search & Filter
                </h5>
                <form method="get">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label-sports">
                                <i class="bi bi-building"></i> Facility Name
                            </label>
                            <input type="text" name="searchName" class="form-control-sports" 
                                   placeholder="Search by name..." value="@Model.SearchName" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-sports">
                                <i class="bi bi-geo-alt-fill"></i> Location
                            </label>
                            <input type="text" name="searchLocation" class="form-control-sports" 
                                   placeholder="Search by location..." value="@Model.SearchLocation" />
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label-sports">
                                <i class="bi bi-calendar-event"></i> Date
                            </label>
                            <input type="date" name="searchDate" class="form-control-sports" 
                                   value="@(Model.SearchDate?.ToString("yyyy-MM-dd"))" 
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            <small style="color: var(--color-gray-600); font-size: 13px;">
                                Find facilities available on this date
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-sports">
                                <i class="bi bi-clock-fill"></i> Time Slot
                            </label>
                            <select name="searchSlotId" class="form-control-sports">
                                <option value="">Any time</option>
                                @for (int hour = 0; hour < 24; hour++)
                                {
                                    var nextHour = (hour + 1) % 24;
                                    var displayHour = hour % 12;
                                    if (displayHour == 0) displayHour = 12;
                                    var period = hour >= 12 ? "PM" : "AM";
                                    var displayNextHour = nextHour % 12;
                                    if (displayNextHour == 0) displayNextHour = 12;
                                    var nextPeriod = nextHour >= 12 ? "PM" : "AM";
                                    var isSelected = Model.SearchSlotId == hour;
                                    
                                    <option value="@hour" selected="@isSelected">@displayHour:00 @period - @displayNextHour:00 @nextPeriod</option>
                                }
                            </select>
                            <small style="color: var(--color-gray-600); font-size: 13px;">
                                Find facilities free at this time
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-search"></i> Search Facilities
                        </button>
                        @if (!string.IsNullOrEmpty(Model.SearchName) || !string.IsNullOrEmpty(Model.SearchLocation) || Model.SearchDate.HasValue || Model.SearchSlotId.HasValue)
                        {
                            <a href="@Url.Page("/Indoors/Index")" class="btn-secondary">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        }
                    </div>
                </form>
            </div>
        </div>
    }

    <!-- Search Results Info -->
    @if (!Model.IsAdmin && Model.SearchDate.HasValue && Model.SearchSlotId.HasValue)
    {
        var slot = IndoorBookingSystem.Models.TimeSlot.GetSlotById(Model.SearchSlotId.Value);
        <div style="background: var(--color-primary-lighter); border-left: 4px solid var(--color-primary); padding: 16px 20px; border-radius: var(--radius-md); margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="bi bi-check-circle-fill" style="color: var(--color-primary); font-size: 24px;"></i>
                <div>
                    <strong style="color: var(--color-gray-900);">Showing available facilities for:</strong><br/>
                    <span style="color: var(--color-gray-700);">
                        @Model.SearchDate.Value.ToString("dddd, MMMM dd, yyyy") at @slot.DisplayName
                    </span>
                </div>
            </div>
        </div>
    }

    <!-- Results Count -->
    @if (Model.Indoors.Count > 0)
    {
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 24px; font-weight: 700; color: var(--color-gray-900);">
                @Model.Indoors.Count @(Model.Indoors.Count == 1 ? "Facility" : "Facilities") Found
            </h3>
        </div>
    }

    <!-- Empty State -->
    @if (Model.Indoors.Count == 0)
    {
        <div class="card-sports text-center" style="padding: 60px 32px;">
            @if (!Model.IsAdmin && Model.SearchDate.HasValue && Model.SearchSlotId.HasValue)
            {
                <i class="bi bi-calendar-x" style="font-size: 64px; color: var(--color-accent); margin-bottom: 20px;"></i>
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--color-gray-900);">
                    No Available Facilities
                </h3>
                <p style="color: var(--color-gray-600); margin-bottom: 24px;">
                    No facilities are available for the selected date and time slot.<br/>
                    Try a different date or time.
                </p>
                <a href="@Url.Page("/Indoors/Index")" class="btn-primary">
                    <i class="bi bi-arrow-left"></i> Browse All Facilities
                </a>
            }
            else
            {
                <i class="bi bi-inbox" style="font-size: 64px; color: var(--color-gray-300); margin-bottom: 20px;"></i>
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--color-gray-900);">
                    No Facilities Found
                </h3>
                <p style="color: var(--color-gray-600);">
                    @if (Model.IsAdmin)
                    {
                        <text>You haven't added any facilities yet.</text>
                    }
                    else
                    {
                        <text>No facilities match your search criteria.</text>
                    }
                </p>
            }
        </div>
    }
    else
    {
        <!-- Facilities Grid -->
        <div class="row g-4">
            @foreach (var indoor in Model.Indoors)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card-sports h-100">
                        <!-- Image -->
                        <div style="position: relative; overflow: hidden;">
                            @if (indoor.MediaUrls.Length > 0)
                            {
                                var imageUrl = indoor.MediaUrls[0].Split('?')[0];
                                var isImage = imageUrl.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) || 
                                             imageUrl.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase) || 
                                             imageUrl.EndsWith(".png", StringComparison.OrdinalIgnoreCase);
                                
                                @if (isImage)
                                {
                                    <img src="@indoor.MediaUrls[0]" class="card-sports-image" alt="@indoor.Name" />
                                }
                                else
                                {
                                    <div style="width: 100%; height: 220px; background: var(--color-gray-200); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-building" style="font-size: 48px; color: var(--color-gray-400);"></i>
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="width: 100%; height: 220px; background: linear-gradient(135deg, var(--color-primary-lighter) 0%, var(--color-primary-light) 100%); display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-building" style="font-size: 48px; color: var(--color-primary);"></i>
                                </div>
                            }
                            
                            <!-- Price Badge -->
                            <div style="position: absolute; top: 12px; right: 12px; background: var(--gradient-primary); color: white; padding: 8px 16px; border-radius: var(--radius-full); font-weight: 700; font-size: 14px; box-shadow: var(--shadow-md);">
                                PKR @indoor.PricePerHour.ToString("N0")/hr
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="card-sports-body">
                            <h3 class="card-sports-title">@indoor.Name</h3>
                            
                            <p style="color: var(--color-gray-600); font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="bi bi-geo-alt-fill" style="color: var(--color-primary);"></i>
                                @indoor.Location
                            </p>
                            
                            <p class="card-sports-text" style="margin-bottom: 16px; min-height: 60px;">
                                @(indoor.Description.Length > 100 ? indoor.Description.Substring(0, 100) + "..." : indoor.Description)
                            </p>
                            
                            <!-- Actions -->
                            <div class="d-flex gap-2 flex-wrap">
                                <a asp-page="Details" asp-route-id="@indoor.Id" class="btn-secondary btn-sm" style="flex: 1;">
                                    <i class="bi bi-eye-fill"></i> Details
                                </a>
                                @if (Model.IsAdmin)
                                {
                                    <a asp-page="Edit" asp-route-id="@indoor.Id" class="btn-secondary btn-sm">
                                        <i class="bi bi-pencil-fill"></i> Edit
                                    </a>
                                    <a asp-page="Pricing" asp-route-id="@indoor.Id" class="btn-secondary btn-sm">
                                        <i class="bi bi-tag-fill"></i> Pricing
                                    </a>
                                }
                                else
                                {
                                    <a asp-page="/Bookings/Create" asp-route-indoorId="@indoor.Id" class="btn-primary btn-sm" style="flex: 1;">
                                        <i class="bi bi-calendar-check-fill"></i> Book Now
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
